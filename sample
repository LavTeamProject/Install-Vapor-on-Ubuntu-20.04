# Laravel: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Ä—Ç–∞–º–∏, –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∏ MCC –∫–æ–¥–∞–º–∏

## –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
```bash
php artisan make:migration create_banks_table
php artisan make:migration create_cards_table
php artisan make:migration create_categories_table
php artisan make:migration create_mcc_codes_table
php artisan make:migration create_category_mcc_table
```

### –ö–æ–¥ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π

#### `create_banks_table.php`
```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateBanksTable extends Migration
{
    public function up()
    {
        Schema::create('banks', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('code');
            $table->string('license')->nullable();
            $table->timestamps();
        });
    }

    public function down()
    {
        Schema::dropIfExists('banks');
    }
}
```

#### `create_cards_table.php`
```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateCardsTable extends Migration
{
    public function up()
    {
        Schema::create('cards', function (Blueprint $table) {
            $table->id();
            $table->unsignedBigInteger('bank_id');
            $table->string('name');
            $table->string('type');
            $table->string('code');
            $table->boolean('allows_category_selection')->default(false);
            $table->text('cashback')->nullable();
            $table->integer('cashback_limit_user')->nullable();
            $table->integer('cashback_limit_premium')->nullable();
            $table->string('rounding')->nullable();
            $table->text('conditions')->nullable();
            $table->timestamps();

            $table->foreign('bank_id')->references('id')->on('banks')->onDelete('cascade');
        });
    }

    public function down()
    {
        Schema::dropIfExists('cards');
    }
}
```

#### `create_categories_table.php`
```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateCategoriesTable extends Migration
{
    public function up()
    {
        Schema::create('categories', function (Blueprint $table) {
            $table->id();
            $table->unsignedBigInteger('card_id');
            $table->string('title');
            $table->string('icon_url')->nullable();
            $table->decimal('min_cashback_percent', 5, 2)->nullable();
            $table->decimal('max_cashback_percent', 5, 2)->nullable();
            $table->timestamps();

            $table->foreign('card_id')->references('id')->on('cards')->onDelete('cascade');
        });
    }

    public function down()
    {
        Schema::dropIfExists('categories');
    }
}
```

#### `create_mcc_codes_table.php`
```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateMccCodesTable extends Migration
{
    public function up()
    {
        Schema::create('mcc_codes', function (Blueprint $table) {
            $table->id();
            $table->string('code');
            $table->string('description')->nullable();
            $table->timestamps();
        });
    }

    public function down()
    {
        Schema::dropIfExists('mcc_codes');
    }
}
```

#### `create_category_mcc_table.php`
```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateCategoryMccTable extends Migration
{
    public function up()
    {
        Schema::create('category_mcc', function (Blueprint $table) {
            $table->unsignedBigInteger('category_id');
            $table->unsignedBigInteger('mcc_code_id');
            $table->timestamps();

            $table->foreign('category_id')->references('id')->on('categories')->onDelete('cascade');
            $table->foreign('mcc_code_id')->references('id')->on('mcc_codes')->onDelete('cascade');
            $table->primary(['category_id', 'mcc_code_id']);
        });
    }

    public function down()
    {
        Schema::dropIfExists('category_mcc');
    }
}
```

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
php artisan migrate
```

---

## –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π
```bash
php artisan make:model Bank -m
php artisan make:model Card -m
php artisan make:model Category -m
php artisan make:model MccCode -m
```

### –ö–æ–¥ –º–æ–¥–µ–ª–µ–π

#### –ú–æ–¥–µ–ª—å `Bank`
```php
namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Bank extends Model
{
    use HasFactory;

    protected $fillable = ['name', 'license'];

    public function cards()
    {
        return $this->hasMany(Card::class);
    }
}
```

#### –ú–æ–¥–µ–ª—å `Card`
```php
namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Card extends Model
{
    use HasFactory;

    protected $fillable = ['bank_id', 'type', 'cashback', 'cashback_limit_user', 'cashback_limit_premium', 'rounding', 'conditions'];

    public function bank()
    {
        return $this->belongsTo(Bank::class);
    }

    public function categories()
    {
        return $this->hasMany(Category::class);
    }
}
```

#### –ú–æ–¥–µ–ª—å `Category`
```php
namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Category extends Model
{
    use HasFactory;

    protected $fillable = ['card_id', 'title', 'icon_url', 'min_cashback_percent', 'max_cashback_percent'];

    public function card()
    {
        return $this->belongsTo(Card::class);
    }

    public function mccCodes()
    {
        return $this->belongsToMany(MccCode::class, 'category_mcc');
    }
}
```

#### –ú–æ–¥–µ–ª—å `MccCode`
```php
namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class MccCode extends Model
{
    use HasFactory;

    protected $fillable = ['code', 'description'];

    public function categories()
    {
        return $this->belongsToMany(Category::class, 'category_mcc');
    }
}
```

---

## –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
```bash
php artisan make:resource CardResource
php artisan make:resource CategoryResource
php artisan make:resource MccCodeResource
```

### –ö–æ–¥ —Ä–µ—Å—É—Ä—Å–æ–≤

#### `CardResource`
```php
namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class CardResource extends JsonResource
{
    public function toArray($request)
    {
        return [
            'id' => $this->id,
            'type' => $this->type,
            'name' => $this->name,
            'allows_category_selection' => $this->allows_category_selection,
            'cashback' => $this->cashback,
            'cashback_limit_user' => $this->cashback_limit_user,
            'cashback_limit_premium' => $this->cashback_limit_premium,
            'rounding' => $this->rounding,
            'conditions' => $this->conditions,
            'categories' => CategoryResource::collection($this->categories),
        ];
    }
}
```

#### `CategoryResource`
```php
namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class CategoryResource extends JsonResource
{
    public function toArray($request)
    {
        return [
            'id' => $this->id,
            'title' => $this->title,
            'icon_url' => $this->icon_url,
            'min_cashback_percent' => $this->min_cashback_percent,
            'max_cashback_percent' => $this->max_cashback_percent,
            'mcc_codes' => MccCodeResource::collection($this->mccCodes),
        ];
    }
}
```

#### `MccCodeResource`
```php
namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class MccCodeResource extends JsonResource
{
    public function toArray($request)
    {
        return [
            'code' => $this->code,
            'description' => $this->description,
        ];
    }
}
```

---

## –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤

### –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
```bash
php artisan make:controller CardController
```

### –ö–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞

#### `CardController`
```php
<?php

namespace App\Http\Controllers;

use App\Http\Resources\CardResource;
use App\Http\Resources\CategoryResource;
use App\Models\Card;
use App\Models\Category;
use App\Models\MccCode;
use Illuminate\Http\Request;
use Illuminate\Validation\ValidationException;
use Illuminate\Database\QueryException;

use Illuminate\Validation\Rule;

class CardController extends Controller
{
    public function index()
    {
        return CardResource::collection(Card::with('categories.mccCodes')->get());
    }

    public function getByMccCode($mcc)
    {
        $cards = Card::whereHas('categories.mccCodes', function ($query) use ($mcc) {
            $query->where('code', $mcc);
        })->with(['categories' => function ($query) use ($mcc) {
            $query->whereHas('mccCodes', function ($subQuery) use ($mcc) {
                $subQuery->where('code', $mcc);
            });
        }])->get();

        return CardResource::collection($cards);
    }

    public function show(Card $card)
    {
        return new CardResource($card->load('categories.mccCodes'));
    }
    
    public function storeCategory(Request $request, Card $card)
    {
         try {
        $validated = $request->validate([
            'title' => [
                'required',
                'string',
                'max:255',
                Rule::unique('categories')->where(function ($query) use ($card) {
                    return $query->where('card_id', $card->id);
                })
            ],
            'icon_url' => 'nullable|url',
            'min_cashback_percent' => 'nullable|numeric|min:0',
            'max_cashback_percent' => 'nullable|numeric|min:0',
        ], [
            // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –¥–ª—è –ø–æ–ª—è title
            'title.unique' => 'The title has already been taken for this card.',
            'title.required' => 'The category title is required.',
            'title.string' => 'The category title must be a string.',
            'title.max' => 'The category title must not exceed 255 characters.',
        ]);

        $category = $card->categories()->create($validated);

        return response()->json([
            'message' => 'Category created successfully.',
            'category' => $category,
        ], 201);
        
    } catch (ValidationException $e) {
            return response()->json([
            'errors' => $e->errors(), // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ –æ—à–∏–±–æ–∫
            ], 400);
    }
    }
    
    
    
    public function addMccCodes(Request $request, Category $category)
    {
        
    try {
        $validated = $request->validate([
            'mcc_code_ids' => 'required|array',
            'mcc_code_ids.*' => 'exists:mcc_codes,code',
        ]);
        
        $validMccCodes = MccCode::whereIn('code', $validated['mcc_code_ids'])->pluck('id')->toArray();

        $category->mccCodes()->syncWithoutDetaching($validMccCodes);

        return response()->json([
            'message' => 'MCC codes added to category successfully.',
            'category' => new CategoryResource($category->load('mccCodes')),
        ]);

    } catch (ValidationException $e) {
            return response()->json([
                'error' => '–ü–µ—Ä–µ–¥–∞–Ω—ã –Ω–µ –≤–∞–ª–∏–¥–Ω—ã–µ MCC'
            ], 400);
    }
    }
    

public function storeCategoriesWithMccCodes(Request $request, Card $card)
{
    try {
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
        $validated = $request->validate([
            'categories' => 'required|array',
            'categories.*.title' => [
                'required',
                'string',
                'max:255',
                Rule::unique('categories')->where(function ($query) use ($card) {
                    return $query->where('card_id', $card->id);
                })
            ],
            'categories.*.icon_url' => 'nullable|url',
            'categories.*.min_cashback_percent' => 'nullable|numeric|min:0',
            'categories.*.max_cashback_percent' => 'nullable|numeric|min:0',
            'categories.*.mcc_code_ids' => 'required|array',
            'categories.*.mcc_code_ids.*' => 'exists:mcc_codes,code',
        ], [
            // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –¥–ª—è –ø–æ–ª—è title
            'categories.*.title.unique' => 'The title has already been taken for this card.',
            'categories.*.title.required' => 'The category title is required.',
            'categories.*.title.string' => 'The category title must be a string.',
            'categories.*.title.max' => 'The category title must not exceed 255 characters.',
        ]);

        // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        $createdCategories = [];

        foreach ($validated['categories'] as $categoryData) {
            // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            $category = $card->categories()->create([
                'title' => $categoryData['title'],
                'icon_url' => $categoryData['icon_url'] ?? '',
                'min_cashback_percent' => $categoryData['min_cashback_percent'],
                'max_cashback_percent' => $categoryData['max_cashback_percent'],
            ]);

            // –ü–æ–ª—É—á–µ–Ω–∏–µ MCC –∫–æ–¥–æ–≤
            $validMccCodes = MccCode::whereIn('code', $categoryData['mcc_code_ids'])->pluck('id')->toArray();

            // –ü—Ä–∏–≤—è–∑–∫–∞ MCC –∫–æ–¥–æ–≤ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            $category->mccCodes()->syncWithoutDetaching($validMccCodes);

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –º–∞—Å—Å–∏–≤ –æ—Ç–≤–µ—Ç–∞
            $createdCategories[] = new CategoryResource($category->load('mccCodes'));
        }

        return response()->json([
            'message' => 'Categories and MCC codes created successfully.',
            'categories' => $createdCategories,
        ], 201);

    } catch (ValidationException $e) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        return response()->json([
            'errors' => $e->errors(), // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ –æ—à–∏–±–æ–∫
        ], 422);

    } catch (QueryException $e) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        return response()->json([
            'error' => 'Database error: ' . $e->getMessage(),
        ], 500);

    } catch (\Exception $e) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –¥—Ä—É–≥–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π
        return response()->json([
            'error' => 'An unexpected error occurred: ' . $e->getMessage(),
        ], 500);
    }
}

}
```

### –ú–∞—Ä—à—Ä—É—Ç—ã –≤ `routes/api.php`
```php
use App\Http\Controllers\CardController;

Route::get('/cards', [CardController::class, 'index']);
Route::get('/cards/mcc/{mcc}', [CardController::class, 'getByMccCode']);
Route::get('/cards/{card}', [CardController::class, 'show']);
Route::post('/cards/{card}/categories', [CardController::class, 'storeCategory']);
Route::post('/categories/{category}/mcc', [CardController::class, 'addMccCodes']);
Route::post('/cards/{card}/storeCategoriesWithMccCodes', [CardController::class, 'storeCategoriesWithMccCodes'])

```

---

## –®–∞–≥ 5: –ó–∞–ø—É—Å–∫ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
   ```bash
   php artisan serve
   ```
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - –°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç: `http://localhost:8000/api/cards`
   - –ö–∞—Ä—Ç—ã –ø–æ MCC: `http://localhost:8000/api/cards/mcc/{mcc}`
   - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—Ä—Ç–µ: `http://localhost:8000/api/cards/{card}`
   - –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫ –∫–∞—Ä—Ç–µ: `http://localhost:8000/api/cards/{card}/categories`
```curl
curl --location 'http://mcc-codes.lantic.ru/api/cards/1/categories' \
--header 'Content-Type: application/json' \
--data '{
            "title": "no_casbback",
            "icon_url": "https://sample.com",
            "min_cashback_percent": 0,
            "max_cashback_percent": 0
         }'
```
   - –î–æ–±–∞–≤–∏—Ç—å MCC –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: `http://localhost:8000/api/categories/{category}/mcc`
```curl
curl --location 'http://mcc-codes.lantic.ru/api/categories/4/mcc' \
--header 'Content-Type: application/json' \
--data '{
    "mcc_code_ids": ["1000"]
}'
```

   - –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ c MCC –∫ –∫–∞—Ä—Ç–µ: `http://localhost:8000/api/cards/{card}/storeCategoriesWithMccCodes`
```curl
curl -X POST "http://localhost:8000/api/cards/{card}/storeCategoriesWithMccCodes" \
-H "Content-Type: application/json" \
-d '{
    "categories": [
        {
            "title": "Shopping",
            "icon_url": "https://example.com/icon.png",
            "min_cashback_percent": 1,
            "max_cashback_percent": 5,
            "mcc_code_ids": ["5411", "5812"]
        },
        {
            "title": "Fuel",
            "min_cashback_percent": 2,
            "max_cashback_percent": 7,
            "mcc_code_ids": ["5541", "5983"]
        }
    ]
}'

```



–ì–æ—Ç–æ–≤–æ! üöÄ





# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∫–µ—à–±—ç–∫–∞ —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —à–∞–≥–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π, –º–æ–¥–µ–ª–µ–π, –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤, —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –ø—Ä–∏–º–µ—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∫–µ—à–±—ç–∫–∞ —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

## –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `user_category_cashback`

```bash
php artisan make:migration create_user_category_cashback_table
```

–ü—Ä–∏–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:

```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateUserCategoryCashbackTable extends Migration
{
    public function up()
    {
        Schema::create('user_category_cashback', function (Blueprint $table) {
            $table->id();
            $table->unsignedBigInteger('user_identifier'); // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            $table->unsignedBigInteger('category_id');
            $table->unsignedBigInteger('card_id');
            $table->decimal('cashback_percent', 5, 2);
            $table->unsignedSmallInteger('month');
            $table->unsignedSmallInteger('year');
            $table->timestamps();

            $table->foreign('category_id')->references('id')->on('categories')->onDelete('cascade');
            $table->foreign('card_id')->references('id')->on('cards')->onDelete('cascade');
        });
    }

    public function down()
    {
        Schema::dropIfExists('user_category_cashback');
    }
}
```

–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:

```bash
php artisan migrate
```

## –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏

```bash
php artisan make:model UserCategoryCashback
```

–ü—Ä–∏–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞ –º–æ–¥–µ–ª–∏:

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class UserCategoryCashback extends Model
{
    use HasFactory;

    protected $table = 'user_category_cashback'; // –£–∫–∞–∑–∞–Ω–∏–µ –∏–º–µ–Ω–∏ —Ç–∞–±–ª–∏—Ü—ã

    protected $fillable = ['user_identifier', 'category_id', 'card_id', 'cashback_percent', 'month', 'year'];

    public function category()
    {
        return $this->belongsTo(Category::class);
    }
    
    public function card()
    {
        return $this->belongsTo(Card::class);
    }
}
```

## –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞

```bash
php artisan make:controller UserCategoryCashbackController
```

–ü—Ä–∏–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞:

```php
<?php

namespace App\Http\Controllers;
use App\Models\Card;
use App\Models\UserCategoryCashback;
use Illuminate\Http\Request;
use App\Http\Resources\UserCategoryCashbackResource;
use Illuminate\Support\Facades\DB;

class UserCategoryCashbackController extends Controller
{
    public function index(Request $request, $month, $year)
    {
        $userIdentifier = $request->user_identifier;

        $cashbacks = UserCategoryCashback::where('user_identifier', $userIdentifier)
            ->where('month', $month)
            ->where('year', $year)
            ->get();

        return UserCategoryCashbackResource::collection($cashbacks);
    }

public function store(Request $request)
{
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–ª–∏—á–∏—è card_id –∏ –æ–±—â–∏—Ö –ø–æ–ª–µ–π
    $validated = $request->validate([
        'user_identifier' => 'required',
        'card_id' => 'required|exists:cards,id', // –í–∞–ª–∏–¥–∏—Ä—É–µ–º card_id
        'month' => 'required|integer|min:1|max:12',
        'year' => 'required|integer|min:2023',
    ]);

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    $userIdentifier = $validated['user_identifier'];
    $cardId = $validated['card_id'];
    $month = $validated['month'];
    $year = $validated['year'];

    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞—Ä—Ç–µ
    $card = Card::find($cardId);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –≤—ã–±–∏—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —ç—Ç–æ–π –∫–∞—Ä—Ç—ã
    if ($card->allows_category_selection) {
        // –ï—Å–ª–∏ –º–æ–∂–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–∞—Å—Å–∏–≤ data
        $validatedData = $request->validate([
            'data' => 'required|array', // data –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –µ—Å–ª–∏ –º–æ–∂–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            'data.*.category_id' => 'required|exists:categories,id',
            'data.*.cashback_percent' => 'required|numeric|min:0|max:100',
        ]);

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –º–∞—Å—Å–∏–≤–∞ data
        DB::transaction(function () use ($userIdentifier, $month, $year, $validatedData, $cardId) {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –º–µ—Å—è—Ü–∞ –∏ –≥–æ–¥–∞
            UserCategoryCashback::where('user_identifier', $userIdentifier)
                ->where('month', $month)
                ->where('year', $year)
                ->delete();

            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –¥–∞–Ω–Ω—ã–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö
            foreach ($validatedData['data'] as $entry) {
                UserCategoryCashback::create([
                    'user_identifier' => $userIdentifier,
                    'category_id' => $entry['category_id'],
                    'card_id' => $cardId,
                    'cashback_percent' => $entry['cashback_percent'],
                    'month' => $month,
                    'year' => $year,
                ]);
            }
        });

    } else {
        // –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ–ª—å–∑—è –≤—ã–±–∏—Ä–∞—Ç—å, –¥–æ–±–∞–≤–ª—è–µ–º –º–æ–∫–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        DB::transaction(function () use ($userIdentifier, $month, $year, $cardId) {
            // –ü–æ–ª—É—á–∞–µ–º –º–æ–∫–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            // $mockCategories = Category::where('is_mock', true)->get();

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –º–µ—Å—è—Ü–∞ –∏ –≥–æ–¥–∞
            UserCategoryCashback::where('user_identifier', $userIdentifier)
                ->where('month', $month)
                ->where('year', $year)
                ->delete();

            // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å –º–æ–∫–æ–≤—ã–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
            // foreach ($mockCategories as $mockCategory) {
                UserCategoryCashback::create([
                    'user_identifier' => "12345",
                    'category_id' => 1,
                    'card_id' => $cardId,
                    'cashback_percent' => 777, // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –º–æ–∫–æ–≤—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                    'month' => $month,
                    'year' => $year,
                ]);
            // }
        });
    }

    return response()->json(['message' => '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.']);
}


    public function history(Request $request)
    {
        $validated = $request->validate([
            'user_identifier' => 'required',
        ]);

        $userIdentifier = $validated['user_identifier'];
        $currentYear = now()->year;
        $cashbacks = UserCategoryCashback::where('user_identifier', $userIdentifier)
            ->where('year', '>=', $currentYear - 1)
            ->orderBy('year', 'desc')
            ->orderBy('month', 'desc')
            ->get();

        return UserCategoryCashbackResource::collection($cashbacks);
    }
}
```

## –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞

```bash
php artisan make:resource UserCategoryCashbackResource
```

–ü—Ä–∏–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞ —Ä–µ—Å—É—Ä—Å–∞:

```php
namespace App\Http\Resources;

use Illuminate\Http\Resources\Json\JsonResource;

class UserCategoryCashbackResource extends JsonResource
{
    public function toArray($request)
    {
        return [
            'id' => $this->id,
            'category' => new CategoryResource($this->category),
            'card' => new CardResource($this->card),
            'cashback_percent' => $this->cashback_percent,
            'month' => $this->month,
            'year' => $this->year,
        ];
    }
}
```

## –®–∞–≥ 5: –†–æ—É—Ç–∏–Ω–≥

–î–æ–±–∞–≤—å—Ç–µ –º–∞—Ä—à—Ä—É—Ç—ã –≤ —Ñ–∞–π–ª `routes/api.php`:

```php
use App\Http\Controllers\UserCategoryCashbackController;

Route::get('/user/cashbacks/{month}/{year}', [UserCategoryCashbackController::class, 'index']);
Route::post('/user/cashbacks', [UserCategoryCashbackController::class, 'store']);
Route::get('/user/cashbacks/history', [UserCategoryCashbackController::class, 'history']);
```

## –ü—Ä–∏–º–µ—Ä—ã cURL-–∑–∞–ø—Ä–æ—Å–æ–≤

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–µ—à–±—ç–∫–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –º–µ—Å—è—Ü–∞ –∏ –≥–æ–¥–∞

```bash
curl -X GET \
  "http://mcc-codes.lantic.ru/api/user/cashbacks/1/2025" \
  -H "Content-Type: application/json" \
  -d '{"user_identifier": 12345}'
```

### –°–æ–∑–¥–∞–Ω–∏–µ –∫–µ—à–±—ç–∫–æ–≤

```bash
curl -X POST \
  "http://mcc-codes.lantic.ru/api/user/cashbacks" \
  -H "Content-Type: application/json" \
  -d '{
    "user_identifier": 12345,
    "month": 1,
    "year": 2025,
    "data": [
      {"category_id": 1, "card_id": 1, "cashback_percent": 5.5},
      {"category_id": 2, "card_id": 1, "cashback_percent": 7.0}
    ]
  }'
```
 
### –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∫–µ—à–±—ç–∫–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥

```bash
curl -X GET \
  "http://mcc-codes.lantic.ru/api/user/cashbacks/history" \
  -H "Content-Type: application/json" \
  -d '{"user_identifier": 12345}'
```



## –®–∞–≥ 100500: –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
```bash
php artisan make:migration create_fixed_categories_for_cards_table
```

### –ö–æ–¥ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π

#### `create_fixed_categories_for_cards_table.php`
```
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateFixedCategoriesForCardsTable extends Migration
{
    public function up()
    {
        Schema::create('fixed_categories_for_cards', function (Blueprint $table) {
            $table->id();
            $table->unsignedBigInteger('card_id'); // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–∞—Ä—Ç—ã
            $table->unsignedBigInteger('category_id'); // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            $table->decimal('cashback_percent', 5, 2); // –ü—Ä–æ—Ü–µ–Ω—Ç –∫–µ—à–±—ç–∫–∞
            $table->timestamps();

            $table->foreign('card_id')->references('id')->on('cards')->onDelete('cascade');
            $table->foreign('category_id')->references('id')->on('categories')->onDelete('cascade');
        });
    }

    public function down()
    {
        Schema::dropIfExists('fixed_categories_for_cards');
    }
}
```



---

## –®–∞–≥ 200500: –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π
```bash
php artisan make:model FixedCategoryForCard
```

#### –ú–æ–¥–µ–ª—å `Category`
```php
namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class FixedCategoryForCard extends Model
{
    use HasFactory;

    protected $table = 'fixed_categories_for_cards'; // –£–∫–∞–∑–∞–Ω–∏–µ –∏–º–µ–Ω–∏ —Ç–∞–±–ª–∏—Ü—ã

    protected $fillable = ['card_id', 'category_id', 'cashback_percent'];

    public function category()
    {
        return $this->belongsTo(Category::class);
    }

    public function card()
    {
        return $this->belongsTo(Card::class);
    }
}
```
